trigger: none
pr: none
resources:
  - repo: self

variables:
  Kubernetes.serviceConnection: "ICTD-HOPE-TRN-uni-apps-aks-hope-dev-ictd-hope-trn-1616938354772"
  Kubernetes.namespace: "ictd-hope-trn"
  Docker.backend.repository: "hope-payment-gateway"
  Docker.registryConnection: "ICTD-HOPE-DEV-ACR"
  Docker.url: "uniappsakshopedev.azurecr.io"
  tag: $(Build.SourceVersion)


stages:
  - stage: deploy
    displayName: DEPLOY
    jobs:
      - job: deploy_hpg
        pool:
          vmImage: 'ubuntu-latest'
        displayName: "[HOPE-PAYMENT-GATEWAY] Deployment"
        steps:
          - checkout: self
          - task: Kubernetes@1
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceEndpoint: $(Kubernetes.serviceConnection)
              command: 'login'
          - task: HelmDeploy@0
            displayName: "Update Chart dependencies"
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceConnection: $(Kubernetes.serviceConnection)
              command: package
              updatedependency: true
              chartPath: '**/ops/hope-payment-gateway'
          - task: HelmDeploy@0
            displayName: "DEPLOY"
            inputs:
              connectionType: 'Kubernetes Service Connection'
              kubernetesServiceConnection: $(Kubernetes.serviceConnection)
              namespace: $(Kubernetes.namespace)
              command: 'upgrade'
              chartType: 'FilePath'
              chartPath: '**/ops/hope-payment-gateway'
              releaseName: 'hpg'
              install: true
              waitForExecution: false
              failOnStderr: true
              valueFile: '**/ops/hope-payment-gateway/values.yaml'
              arguments: "--timeout 600s"
              overrideValues: "
                image.repository=$(Docker.url)/$(Docker.backend.repository),\
                image.tag=trn-$(tag) \
                "